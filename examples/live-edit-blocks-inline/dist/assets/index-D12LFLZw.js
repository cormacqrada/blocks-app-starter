var E=Object.defineProperty;var B=(p,e,t)=>e in p?E(p,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[e]=t;var u=(p,e,t)=>B(p,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function t(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=t(o);fetch(o.href,r)}})();class f{constructor(e){u(this,"tree");u(this,"adapters",[]);this.tree=e}getTree(){return this.tree}applyDeltas(e){var t;for(const n of e)n.kind==="update"&&n.path==="root"&&n.block&&(this.tree=n.block);for(const n of this.adapters)(t=n.onDeltas)==null||t.call(n,e,this)}registerAdapter(e){this.adapters.push(e)}}const k=[{id:"paragraph",label:"Paragraph",description:"Basic rich text paragraph",element:"paragraph",defaultProps:{text:"Write something..."},propSchema:[{name:"text",label:"Text",type:"string"}]},{id:"heading",label:"Heading",description:"Section heading (H1â€“H4)",element:"heading",defaultProps:{level:2,text:"Heading"},propSchema:[{name:"text",label:"Text",type:"string"},{name:"level",label:"Level",type:"enum",options:["1","2","3","4"]}]},{id:"blockquote",label:"Blockquote",description:"Quoted text callout",element:"blockquote",defaultProps:{text:"A short, punchy quote."},propSchema:[{name:"text",label:"Text",type:"string"}]},{id:"code",label:"Code",description:"Code block with optional language",element:"code",defaultProps:{text:"console.log('Hello, Blocks!')",language:"ts"},propSchema:[{name:"text",label:"Code",type:"string"},{name:"language",label:"Language",type:"string"}]},{id:"input",label:"Input",description:"Semantic text input",element:"input",defaultProps:{name:"email",text:"Email",inputType:"email",placeholder:"you@example.com"},propSchema:[{name:"text",label:"Label",type:"string"},{name:"name",label:"Name",type:"string"}]},{id:"textarea",label:"Textarea",description:"Multi-line text input",element:"textarea",defaultProps:{name:"bio",text:"Bio",placeholder:"Tell us about yourself...",rows:3},propSchema:[{name:"text",label:"Label",type:"string"},{name:"name",label:"Name",type:"string"}]},{id:"button",label:"Button",description:"Semantic button",element:"button",defaultProps:{text:"Save changes",variant:"primary"},propSchema:[{name:"text",label:"Label",type:"string"}]}];function v(p,e){return{id:e,type:"visual",version:"1.0.0",properties:{element:p.element,...p.defaultProps},children:[]}}function x(p){if(p)return k.find(e=>e.element===p)}class w{constructor(e,t){u(this,"runtime");u(this,"events");u(this,"_selectedBlockId",null);u(this,"tree");this.tree=e??{rootId:"root",blocks:[]},this.runtime=new f(this.tree),this.events=t??{}}getTree(){return this.tree}get blocks(){return this.tree.blocks}get selectedBlockId(){return this._selectedBlockId}set selectedBlockId(e){var t,n;this._selectedBlockId=e,(n=(t=this.events).onSelect)==null||n.call(t,e)}getRegistry(){return k}nextLocalId(e){const t=Math.random().toString(36).slice(2,8);return`${e}:${t}`}deleteBlock(e){var r,c,i,l;const t=this.tree.blocks;if(t.findIndex(s=>s.id===e)===-1)return;const o=t.filter(s=>s.id!==e);this.tree={...this.tree,blocks:o},this.runtime=new f(this.tree),this._selectedBlockId===e&&(this._selectedBlockId=null,(c=(r=this.events).onSelect)==null||c.call(r,null)),(l=(i=this.events).onChange)==null||l.call(i,this.tree)}applyDeltas(e){var t,n;this.runtime.applyDeltas(e),this.tree=this.runtime.getTree(),(n=(t=this.events).onChange)==null||n.call(t,this.tree)}insertBlock(e,t){var d,h,m,b,g,y;const n=k.find(C=>C.id===e);if(!n)throw new Error(`Unknown registry block id: ${e}`);const o=this.nextLocalId(n.element),r=v(n,o),c=this.tree.blocks.length,i=this.tree.blocks,l=t!=null?Math.max(0,Math.min(t,i.length)):i.length,s=[...i];s.splice(l,0,r),this.tree={...this.tree,blocks:s},this.runtime=new f(this.tree);const a=s.length;return console.log("EditorAdapter.insertBlock",{registryId:e,before:c,after:a,insertIndex:l,newBlockId:r.id}),this._selectedBlockId=r.id,(h=(d=this.events).onInsert)==null||h.call(d,r,l),(b=(m=this.events).onChange)==null||b.call(m,this.tree),(y=(g=this.events).onSelect)==null||y.call(g,r.id),r}updateBlockProps(e,t){var c,i,l,s;const o=this.tree.blocks.map(a=>a.id===e?{...a,properties:{...a.properties,...t}}:a);this.tree={...this.tree,blocks:o},this.runtime=new f(this.tree);const r=o.find(a=>a.id===e);r&&((i=(c=this.events).onPropChange)==null||i.call(c,r)),(s=(l=this.events).onChange)==null||s.call(l,this.tree)}selectBlock(e){this.selectedBlockId=e}}class S{constructor(e){u(this,"adapter");u(this,"container");u(this,"cmdMenuRoot");u(this,"cmdMenuEl",null);u(this,"cmdSearchEl",null);u(this,"cmdContext",null);u(this,"handleKeyDown",e=>{e.target===this.container&&e.key==="/"&&(e.preventDefault(),this.openCmdMenu())});this.adapter=e.adapter,this.container=e.container,this.cmdMenuRoot=e.cmdMenuRoot,this.container.tabIndex=0,this.container.addEventListener("keydown",this.handleKeyDown),this.container.addEventListener("click",t=>{t.target===this.container&&(this.adapter.selectBlock(null),this.closeCmdMenu())}),this.render()}openCmdMenu(e){if(this.cmdMenuEl)return;e?this.cmdContext=e:this.cmdContext=null;const t=document.createElement("div");t.className="cmd-menu";const n=document.createElement("input");n.className="cmd-menu-search",n.placeholder="Search blocks...";const o=document.createElement("div");o.className="cmd-menu-list";const r=()=>{const i=n.value.toLowerCase();o.innerHTML="",this.adapter.getRegistry().filter(s=>s.label.toLowerCase().includes(i)||(s.description??"").toLowerCase().includes(i)).forEach(s=>{const a=document.createElement("button");a.className="cmd-menu-item",a.textContent=s.label,a.onclick=()=>{const d=this.cmdContext;if(d){const h=d.editable.textContent??"";this.adapter.updateBlockProps(d.blockId,{element:s.element,...s.defaultProps,text:h||s.defaultProps.text})}else this.adapter.insertBlock(s.id);this.closeCmdMenu()},o.appendChild(a)})};n.addEventListener("input",r),t.appendChild(n),t.appendChild(o),this.cmdMenuRoot.appendChild(t),this.cmdMenuEl=t,this.cmdSearchEl=n,r(),setTimeout(()=>n.focus(),0);const c=i=>{i.key==="Escape"&&(i.preventDefault(),this.closeCmdMenu())};t.addEventListener("keydown",c)}closeCmdMenu(){this.cmdMenuEl&&(this.cmdMenuRoot.removeChild(this.cmdMenuEl),this.cmdMenuEl=null,this.cmdSearchEl=null,this.cmdContext=null)}render(){const e=this.adapter.blocks;console.debug("DocEditor.render",{count:e.length,blocks:e}),this.container.innerHTML="",e.forEach((t,n)=>{const o=document.createElement("div");o.className="doc-block-wrapper",o.dataset.blockId=t.id,this.adapter.selectedBlockId===t.id&&o.classList.add("selected"),o.onclick=i=>{i.stopPropagation(),this.adapter.selectBlock(t.id)};const r=document.createElement("div");r.className="doc-block-content";const c=document.createElement("div");c.className="doc-block-editable",c.contentEditable="true",c.spellcheck=!0,this.renderBlockPreview(t,c),c.addEventListener("keydown",i=>{if(i.key==="/"){i.preventDefault(),this.openCmdMenu({blockId:t.id,blockIndex:n,editable:c});return}if(i.key==="Enter"&&!i.shiftKey){i.preventDefault();const l=this.adapter.insertBlock("paragraph",n+1);this.render();const s=this.container.querySelector(`.doc-block-wrapper[data-block-id="${l.id}"] .doc-block-editable`);s==null||s.focus();return}if(i.key==="Backspace"&&!i.shiftKey&&(c.textContent??"").trim().length===0){const s=this.adapter.blocks;if(s.length>1){i.preventDefault();const a=s[n-1];if(this.adapter.deleteBlock(t.id),this.render(),a){const d=this.container.querySelector(`.doc-block-wrapper[data-block-id="${a.id}"] .doc-block-editable`);d==null||d.focus()}return}}}),c.addEventListener("blur",()=>{const i=c.textContent??"";this.adapter.updateBlockProps(t.id,{text:i})}),r.appendChild(c),o.appendChild(r),this.container.appendChild(o)})}renderBlockPreview(e,t){var c;const n=(c=e.properties)==null?void 0:c.element,o=x(n),r=e.properties??{};if(t.innerHTML="",!o){t.textContent=`Unknown block: ${n??"(no element)"}`;return}switch(o.element){case"heading":{const i=Number(r.level??2),l=String(r.text??"Heading"),s="h"+Math.min(Math.max(i,1),4),a=document.createElement(s);a.textContent=l,t.appendChild(a);break}case"blockquote":{const i=String(r.text??""),l=document.createElement("blockquote");l.textContent=i,t.appendChild(l);break}case"code":{const i=String(r.text??""),l=document.createElement("pre"),s=document.createElement("code");s.textContent=i,l.appendChild(s),t.appendChild(l);break}case"paragraph":default:{const i=String(r.text??""),l=document.createElement("p");l.textContent=i,t.appendChild(l);break}}}}class M{constructor(e){u(this,"adapter");u(this,"container");this.adapter=e.adapter,this.container=e.container,this.render()}render(){this.container.innerHTML="";const e=document.createElement("div");e.className="block-picker-list",k.forEach(t=>{const n=document.createElement("button");n.className="block-picker-item",n.type="button",n.onclick=()=>this.adapter.insertBlock(t.id);const o=document.createElement("div");o.textContent=t.label;const r=document.createElement("div");r.textContent=t.description??"",r.style.fontSize="0.7rem",r.style.opacity="0.8",n.appendChild(o),t.description&&n.appendChild(r),e.appendChild(n)}),this.container.appendChild(e)}}class L{constructor(e){u(this,"adapter");u(this,"container");this.adapter=e.adapter,this.container=e.container,this.render()}render(){this.container.innerHTML="";const e=this.adapter.selectedBlockId;if(!e){const n=document.createElement("div");n.textContent="No block selected",n.style.fontSize="0.8rem",n.style.color="#9ca3af",this.container.appendChild(n);return}const t=this.adapter.blocks.find(n=>n.id===e);if(!t){const n=document.createElement("div");n.textContent="Selected block not found",this.container.appendChild(n);return}this.renderBlock(t)}renderBlock(e){var r;const t=(r=e.properties)==null?void 0:r.element,n=x(t);if(!n){const c=document.createElement("div");c.textContent=`Unknown block type: ${t??"(none)"}`,this.container.appendChild(c);return}const o=document.createElement("div");o.textContent=n.label,o.style.fontSize="0.85rem",o.style.fontWeight="600",o.style.marginBottom="0.4rem",this.container.appendChild(o),n.propSchema.forEach(c=>{var a;const i=document.createElement("div");i.className="prop-field";const l=document.createElement("label");l.textContent=c.label,i.appendChild(l);const s=(a=e.properties)==null?void 0:a[c.name];if(c.type==="string"||c.type==="number"){const d=document.createElement("input");d.type=c.type==="number"?"number":"text",d.value=s!=null?String(s):"",d.onchange=()=>{const h=d.value,m=c.type==="number"?Number(h):h;this.adapter.updateBlockProps(e.id,{[c.name]:m})},i.appendChild(d)}else if(c.type==="enum"){const d=document.createElement("select");(c.options??[]).forEach(h=>{const m=document.createElement("option");m.value=h,m.textContent=h,String(s)===h&&(m.selected=!0),d.appendChild(m)}),d.onchange=()=>{this.adapter.updateBlockProps(e.id,{[c.name]:d.value})},i.appendChild(d)}this.container.appendChild(i)})}}const P={rootId:"root",blocks:[]};function I(){const p=document.getElementById("doc-editor"),e=document.getElementById("block-picker-panel"),t=document.getElementById("properties-panel"),n=document.getElementById("cmd-menu-root");if(!p||!e||!t||!n)throw new Error("Missing editor DOM roots");const o=new w(P,{onChange:()=>{r.render(),i.render()},onSelect:()=>{r.render(),i.render()}}),r=new S({adapter:o,container:p,cmdMenuRoot:n}),c=new M({adapter:o,container:e}),i=new L({adapter:o,container:t});window.__blocksEditor={adapter:o,docEditor:r,picker:c,propsPanel:i}}I();

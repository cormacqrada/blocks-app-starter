var w=Object.defineProperty;var I=(u,e,t)=>e in u?w(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var f=(u,e,t)=>I(u,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();class g{constructor(e){f(this,"tree");f(this,"adapters",[]);this.tree=e}getTree(){return this.tree}applyDeltas(e){var t;for(const n of e)n.kind==="update"&&n.path==="root"&&n.block&&(this.tree=n.block);for(const n of this.adapters)(t=n.onDeltas)==null||t.call(n,e,this)}registerAdapter(e){this.adapters.push(e)}}const b=[{id:"paragraph",label:"Paragraph",description:"Basic rich text paragraph",element:"paragraph",kind:"text",transformable:!0,defaultProps:{text:"Write something..."},propSchema:[{name:"text",label:"Text",type:"string"}]},{id:"heading",label:"Heading",description:"Section heading (H1â€“H4)",element:"heading",kind:"text",transformable:!0,defaultProps:{level:2,text:"Heading"},propSchema:[{name:"text",label:"Text",type:"string"},{name:"level",label:"Level",type:"enum",options:["1","2","3","4"]}]},{id:"blockquote",label:"Blockquote",description:"Quoted text callout",element:"blockquote",kind:"text",transformable:!0,defaultProps:{text:"A short, punchy quote."},propSchema:[{name:"text",label:"Text",type:"string"}]},{id:"code",label:"Code",description:"Code block with optional language",element:"code",kind:"text",transformable:!0,defaultProps:{text:"console.log('Hello, Blocks!')",language:"ts"},propSchema:[{name:"text",label:"Code",type:"string"},{name:"language",label:"Language",type:"string"}]},{id:"input",label:"Input",description:"Semantic text input",element:"input",kind:"control",defaultProps:{name:"email",text:"Email",inputType:"email",placeholder:"you@example.com"},propSchema:[{name:"text",label:"Label",type:"string"},{name:"name",label:"Name",type:"string"}]},{id:"textarea",label:"Textarea",description:"Multi-line text input",element:"textarea",kind:"control",defaultProps:{name:"bio",text:"Bio",placeholder:"Tell us about yourself...",rows:3},propSchema:[{name:"text",label:"Label",type:"string"},{name:"name",label:"Name",type:"string"}]},{id:"button",label:"Button",description:"Semantic button",element:"button",kind:"control",defaultProps:{text:"Save changes",variant:"primary"},propSchema:[{name:"text",label:"Label",type:"string"}]}];function S(u,e){return{id:e,type:"visual",version:"1.0.0",properties:{element:u.element,...u.defaultProps},children:[]}}function v(u){if(u)return b.find(e=>e.element===u)}class M{constructor(e,t){f(this,"runtime");f(this,"events");f(this,"_selectedBlockId",null);f(this,"tree");this.tree=e??{rootId:"root",blocks:[]},this.runtime=new g(this.tree),this.events=t??{}}getTree(){return this.tree}get blocks(){return this.tree.blocks}get selectedBlockId(){return this._selectedBlockId}set selectedBlockId(e){var t,n;this._selectedBlockId=e,(n=(t=this.events).onSelect)==null||n.call(t,e)}getRegistry(){return b}getRegistryById(e){return b.find(t=>t.id===e)}getRegistryByElement(e){if(e)return b.find(t=>t.element===e)}notifyInserterOpen(e){var t,n;(n=(t=this.events).onInserterOpen)==null||n.call(t,e)}notifyInserterClose(){var e,t;(t=(e=this.events).onInserterClose)==null||t.call(e)}nextLocalId(e){const t=Math.random().toString(36).slice(2,8);return`${e}:${t}`}deleteBlock(e){var s,i,o,c,d,l;const t=this.tree.blocks;if(t.findIndex(a=>a.id===e)===-1)return;const r=t.filter(a=>a.id!==e);this.tree={...this.tree,blocks:r},this.runtime=new g(this.tree),this._selectedBlockId===e&&(this._selectedBlockId=null,(i=(s=this.events).onSelect)==null||i.call(s,null)),(c=(o=this.events).onRemove)==null||c.call(o,e),(l=(d=this.events).onChange)==null||l.call(d,this.tree)}applyDeltas(e){var t,n;this.runtime.applyDeltas(e),this.tree=this.runtime.getTree(),(n=(t=this.events).onChange)==null||n.call(t,this.tree)}insertBlock(e,t){var a,h,p,k,m,x;const n=this.getRegistryById(e);if(!n)throw new Error(`Unknown registry block id: ${e}`);const r=this.nextLocalId(n.element),s=S(n,r),i=this.tree.blocks.length,o=this.tree.blocks,c=t!=null?Math.max(0,Math.min(t,o.length)):o.length,d=[...o];d.splice(c,0,s),this.tree={...this.tree,blocks:d},this.runtime=new g(this.tree);const l=d.length;return console.log("EditorAdapter.insertBlock",{registryId:e,before:i,after:l,insertIndex:c,newBlockId:s.id}),this._selectedBlockId=s.id,(h=(a=this.events).onInsert)==null||h.call(a,s,c),(k=(p=this.events).onChange)==null||k.call(p,this.tree),(x=(m=this.events).onSelect)==null||x.call(m,s.id),s}updateBlockProps(e,t){var i,o,c,d;const r=this.tree.blocks.map(l=>l.id===e?{...l,properties:{...l.properties,...t}}:l);this.tree={...this.tree,blocks:r},this.runtime=new g(this.tree);const s=r.find(l=>l.id===e);s&&((o=(i=this.events).onPropChange)==null||o.call(i,s)),(d=(c=this.events).onChange)==null||d.call(c,this.tree)}transformBlock(e,t){var i,o;const n=this.getRegistryById(t);if(!n)return;const s=this.tree.blocks.map(c=>{var h,p;if(c.id!==e)return c;const d=String(c.properties.element??"paragraph"),l=c.properties.text,a={...c,properties:{...c.properties,element:n.element,...n.defaultProps,text:l??n.defaultProps.text}};return(p=(h=this.events).onTransform)==null||p.call(h,a,d,n.element),a});this.tree={...this.tree,blocks:s},this.runtime=new g(this.tree),(o=(i=this.events).onChange)==null||o.call(i,this.tree)}selectBlock(e){this.selectedBlockId=e}setCursor(e,t){var n,r;(r=(n=this.events).onCursorMove)==null||r.call(n,{blockId:e,offset:t})}}class P{constructor(e){f(this,"adapter");f(this,"container");f(this,"cmdMenuRoot");f(this,"cmdMenuEl",null);f(this,"cmdSearchEl",null);f(this,"cmdContext",null);f(this,"handleKeyDown",e=>{e.target===this.container&&e.key==="/"&&(e.preventDefault(),this.openCmdMenu())});this.adapter=e.adapter,this.container=e.container,this.cmdMenuRoot=e.cmdMenuRoot,this.container.tabIndex=0,this.container.addEventListener("keydown",this.handleKeyDown),this.container.addEventListener("click",t=>{t.target===this.container&&(this.adapter.selectBlock(null),this.closeCmdMenu())}),this.render()}openCmdMenu(e){if(this.cmdMenuEl)return;e?(this.cmdContext=e,this.adapter.notifyInserterOpen({blockId:e.blockId,blockIndex:e.blockIndex,mode:e.mode})):(this.cmdContext=null,this.adapter.notifyInserterOpen({blockId:null,blockIndex:null,mode:"insert"}));const t=document.createElement("div");t.className="cmd-menu";const n=document.createElement("input");n.className="cmd-menu-search",n.placeholder="Search blocks...";const r=document.createElement("div");r.className="cmd-menu-list";const s=()=>{const o=n.value.toLowerCase();r.innerHTML="";const c=this.adapter.getRegistry(),d=this.cmdContext,l=(d==null?void 0:d.mode)??"insert";c.filter(a=>a.label.toLowerCase().includes(o)||(a.description??"").toLowerCase().includes(o)).filter(a=>l==="transform"?a.transformable:!0).forEach(a=>{const h=document.createElement("button");h.className="cmd-menu-item",h.textContent=a.label,h.onclick=()=>{const p=this.cmdContext;if(p)if(p.mode==="transform")this.adapter.transformBlock(p.blockId,a.id);else{const k=p.editable.textContent??"",m=p.caretOffset,x=k.slice(0,m),E=k.slice(m);this.adapter.updateBlockProps(p.blockId,{text:x});const C=p.blockIndex+1;let y=null;if(E.length>0){const B=this.adapter.insertBlock("paragraph",C);this.adapter.updateBlockProps(B.id,{text:E}),y=this.adapter.insertBlock(a.id,C+1).id}else y=this.adapter.insertBlock(a.id,C).id;y&&this.adapter.setCursor(y,0)}else{const k=this.adapter.insertBlock(a.id);this.adapter.setCursor(k.id,0)}this.closeCmdMenu()},r.appendChild(h)})};n.addEventListener("input",s),t.appendChild(n),t.appendChild(r),this.cmdMenuRoot.appendChild(t),this.cmdMenuEl=t,this.cmdSearchEl=n,s(),setTimeout(()=>n.focus(),0);const i=o=>{o.key==="Escape"&&(o.preventDefault(),this.closeCmdMenu())};t.addEventListener("keydown",i)}closeCmdMenu(){this.cmdMenuEl&&(this.cmdMenuRoot.removeChild(this.cmdMenuEl),this.cmdMenuEl=null,this.cmdSearchEl=null,this.cmdContext=null,this.adapter.notifyInserterClose())}render(){const e=this.adapter.blocks;console.debug("DocEditor.render",{count:e.length,blocks:e}),this.container.innerHTML="",e.forEach((t,n)=>{const r=document.createElement("div");r.className="doc-block-wrapper",r.dataset.blockId=t.id,this.adapter.selectedBlockId===t.id&&r.classList.add("selected"),r.onclick=o=>{o.stopPropagation(),this.adapter.selectBlock(t.id)};const s=document.createElement("div");s.className="doc-block-content";const i=document.createElement("div");i.className="doc-block-editable",i.contentEditable="true",i.spellcheck=!0,this.renderBlockPreview(t,i),i.addEventListener("keydown",o=>{const c=window.getSelection(),d=c&&c.anchorNode?c.anchorOffset:(i.textContent??"").length;if(this.adapter.setCursor(t.id,d),this.cmdMenuEl&&this.cmdSearchEl){if(o.key.length===1&&!o.metaKey&&!o.ctrlKey&&!o.altKey){o.preventDefault(),this.cmdSearchEl.value+=o.key,this.cmdSearchEl.dispatchEvent(new Event("input"));return}if(o.key==="Backspace"){o.preventDefault(),this.cmdSearchEl.value=this.cmdSearchEl.value.slice(0,-1),this.cmdSearchEl.dispatchEvent(new Event("input"));return}}if(o.key==="/"){o.preventDefault();const h=(i.textContent??"").slice(0,d).trimStart().length===0?"transform":"insert";this.openCmdMenu({blockId:t.id,blockIndex:n,editable:i,mode:h,caretOffset:d});return}if(o.key==="Enter"&&!o.shiftKey){o.preventDefault();const l=this.adapter.insertBlock("paragraph",n+1);this.render();const a=this.container.querySelector(`.doc-block-wrapper[data-block-id="${l.id}"] .doc-block-editable`);a==null||a.focus(),this.adapter.setCursor(l.id,0);return}if(o.key===" "&&!o.shiftKey){const l=i.textContent??"",a=l.slice(0,d);l.slice(d);const h=a.trimStart(),k=[{match:"#",action:()=>{const m=l.replace(/^\s*#\s+/,"");this.adapter.transformBlock(t.id,"heading"),this.adapter.updateBlockProps(t.id,{level:1,text:m})}},{match:"##",action:()=>{const m=l.replace(/^\s*##\s+/,"");this.adapter.transformBlock(t.id,"heading"),this.adapter.updateBlockProps(t.id,{level:2,text:m})}},{match:"###",action:()=>{const m=l.replace(/^\s*###\s+/,"");this.adapter.transformBlock(t.id,"heading"),this.adapter.updateBlockProps(t.id,{level:3,text:m})}},{match:">",action:()=>{const m=l.replace(/^\s*>\s+/,"");this.adapter.transformBlock(t.id,"blockquote"),this.adapter.updateBlockProps(t.id,{text:m})}}].find(m=>h===m.match);if(k){o.preventDefault(),k.action(),this.render();const m=this.container.querySelector(`.doc-block-wrapper[data-block-id="${t.id}"] .doc-block-editable`);m==null||m.focus(),this.adapter.setCursor(t.id,0);return}}if(o.key==="Backspace"&&!o.shiftKey&&(i.textContent??"").trim().length===0){const a=this.adapter.blocks;if(a.length>1){o.preventDefault();const h=a[n-1];if(this.adapter.deleteBlock(t.id),this.render(),h){const p=this.container.querySelector(`.doc-block-wrapper[data-block-id="${h.id}"] .doc-block-editable`);p==null||p.focus()}return}}}),i.addEventListener("blur",()=>{const o=i.textContent??"";this.adapter.updateBlockProps(t.id,{text:o})}),s.appendChild(i),r.appendChild(s),this.container.appendChild(r)})}renderBlockPreview(e,t){var i;const n=(i=e.properties)==null?void 0:i.element,r=v(n),s=e.properties??{};if(t.innerHTML="",!r){t.textContent=`Unknown block: ${n??"(no element)"}`;return}switch(r.element){case"heading":{const o=Number(s.level??2),c=String(s.text??"Heading"),d="h"+Math.min(Math.max(o,1),4),l=document.createElement(d);l.textContent=c,t.appendChild(l);break}case"blockquote":{const o=String(s.text??""),c=document.createElement("blockquote");c.textContent=o,t.appendChild(c);break}case"code":{const o=String(s.text??""),c=document.createElement("pre"),d=document.createElement("code");d.textContent=o,c.appendChild(d),t.appendChild(c);break}case"paragraph":default:{const o=String(s.text??""),c=document.createElement("p");c.textContent=o,t.appendChild(c);break}}}}class L{constructor(e){f(this,"adapter");f(this,"container");this.adapter=e.adapter,this.container=e.container,this.render()}render(){this.container.innerHTML="";const e=document.createElement("div");e.className="block-picker-list",b.forEach(t=>{const n=document.createElement("button");n.className="block-picker-item",n.type="button",n.onclick=()=>this.adapter.insertBlock(t.id);const r=document.createElement("div");r.textContent=t.label;const s=document.createElement("div");s.textContent=t.description??"",s.style.fontSize="0.7rem",s.style.opacity="0.8",n.appendChild(r),t.description&&n.appendChild(s),e.appendChild(n)}),this.container.appendChild(e)}}class T{constructor(e){f(this,"adapter");f(this,"container");this.adapter=e.adapter,this.container=e.container,this.render()}render(){this.container.innerHTML="";const e=this.adapter.selectedBlockId;if(!e){const n=document.createElement("div");n.textContent="No block selected",n.style.fontSize="0.8rem",n.style.color="#9ca3af",this.container.appendChild(n);return}const t=this.adapter.blocks.find(n=>n.id===e);if(!t){const n=document.createElement("div");n.textContent="Selected block not found",this.container.appendChild(n);return}this.renderBlock(t)}renderBlock(e){var s;const t=(s=e.properties)==null?void 0:s.element,n=v(t);if(!n){const i=document.createElement("div");i.textContent=`Unknown block type: ${t??"(none)"}`,this.container.appendChild(i);return}const r=document.createElement("div");r.textContent=n.label,r.style.fontSize="0.85rem",r.style.fontWeight="600",r.style.marginBottom="0.4rem",this.container.appendChild(r),n.propSchema.forEach(i=>{var l;const o=document.createElement("div");o.className="prop-field";const c=document.createElement("label");c.textContent=i.label,o.appendChild(c);const d=(l=e.properties)==null?void 0:l[i.name];if(i.type==="string"||i.type==="number"){const a=document.createElement("input");a.type=i.type==="number"?"number":"text",a.value=d!=null?String(d):"",a.onchange=()=>{const h=a.value,p=i.type==="number"?Number(h):h;this.adapter.updateBlockProps(e.id,{[i.name]:p})},o.appendChild(a)}else if(i.type==="enum"){const a=document.createElement("select");(i.options??[]).forEach(h=>{const p=document.createElement("option");p.value=h,p.textContent=h,String(d)===h&&(p.selected=!0),a.appendChild(p)}),a.onchange=()=>{this.adapter.updateBlockProps(e.id,{[i.name]:a.value})},o.appendChild(a)}this.container.appendChild(o)})}}const N={rootId:"root",blocks:[]};function R(){const u=document.getElementById("doc-editor"),e=document.getElementById("block-picker-panel"),t=document.getElementById("properties-panel"),n=document.getElementById("cmd-menu-root");if(!u||!e||!t||!n)throw new Error("Missing editor DOM roots");const r=new M(N,{onChange:()=>{s.render(),o.render()},onSelect:()=>{s.render(),o.render()},onInsert:(c,d)=>{console.log("block.inserted",{id:c.id,element:c.properties.element,index:d})},onTransform:(c,d,l)=>{console.log("block.transformed",{id:c.id,from:d,to:l})},onCursorMove:c=>{console.debug("cursor.moved",c)},onRemove:c=>{console.log("block.removed",{blockId:c})},onInserterOpen:c=>{console.debug("inserter.opened",c)},onInserterClose:()=>{console.debug("inserter.closed")}}),s=new P({adapter:r,container:u,cmdMenuRoot:n}),i=new L({adapter:r,container:e}),o=new T({adapter:r,container:t});window.__blocksEditor={adapter:r,docEditor:s,picker:i,propsPanel:o}}R();
